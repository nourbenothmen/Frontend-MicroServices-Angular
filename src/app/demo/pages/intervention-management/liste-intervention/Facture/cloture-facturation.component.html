<div class="container py-4">

  <!-- Titre diff√©rent selon le mode -->
  <h2 class="text-center text-primary mb-4" *ngIf="mode === 'impression'">
    üìÑ Facture de l'Intervention INT-{{ intervention.Id | number:'3.0-0':'' }}
  </h2>
  <h3 class="mb-4" *ngIf="mode === 'edition'">
    Cl√¥turer et Facturer l'Intervention #{{ intervention.Id }}
  </h3>

  <!-- Alerte Hors Garantie (seulement en √©dition) -->
  <div class="alert alert-warning d-flex align-items-center" *ngIf="mode === 'edition' && !intervention.EstSousGarantie">
    <span class="me-2">‚ö†Ô∏è</span>
    <div>
      <strong>Intervention Hors Garantie</strong><br>
      Cette intervention est payante. Veuillez √©tablir la facture incluant les pi√®ces et la main d'≈ìuvre.
    </div>
  </div>

  <!-- Informations Client -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      Informations Client
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Client:</strong> {{ intervention.ClientNom }}</p>
          <p><strong>Technicien:</strong> {{ intervention.TechnicienNom }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Article:</strong> {{ intervention.ArticleNom }}</p>
          <p><strong>Date intervention:</strong> {{ intervention.DateIntervention | date:'short' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Rapport d'Intervention -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      Rapport d'Intervention
    </div>
    <div class="card-body">
      <!-- √âdition : textarea modifiable -->
      <textarea *ngIf="mode === 'edition'" class="form-control" rows="4" [(ngModel)]="intervention.Description"
                placeholder="Remplacement du thermostat d√©fectueux et nettoyage du syst√®me..."></textarea>
      
      <!-- Impression : affichage simple -->
      <div *ngIf="mode === 'impression'" class="p-3 bg-light rounded">
        <p class="mb-0">{{ intervention.Description || 'Aucun rapport saisi.' }}</p>
      </div>
    </div>
  </div>

  <!-- D√©tails de la Facturation -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      D√©tails de la Facturation
    </div>
    <div class="card-body">

      <!-- Pi√®ces et Mat√©riel -->
      <h5 class="d-flex justify-content-between align-items-center">
        Pi√®ces et Mat√©riel
        <button *ngIf="mode === 'edition'" class="btn btn-primary btn-sm" (click)="addPart()">
          + Ajouter une pi√®ce
        </button>
      </h5>

      <table class="table table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>D√©signation</th>
            <th>Quantit√©</th>
            <th>Prix unitaire (TND)</th>
            <th *ngIf="mode === 'edition'">Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Liste des pi√®ces existantes -->
          <tr *ngFor="let part of intervention.Pieces">
            <td>{{ part.NomPiece }}</td>
            <td>{{ part.Quantite }}</td>
            <td>{{ part.PrixUnitaire | number:'1.2-2' }}</td>
            <td *ngIf="mode === 'edition'">
              <button class="btn btn-danger btn-sm" (click)="deletePart(part.Id)">Supprimer</button>
            </td>
          </tr>

          <!-- Ligne d'ajout (seulement en √©dition) -->
          <tr *ngIf="mode === 'edition'">
            <td><input class="form-control" [(ngModel)]="newPart.NomPiece" placeholder="Thermostat √©lectronique"></td>
            <td><input class="form-control" type="number" [(ngModel)]="newPart.Quantite" min="1" [value]="1"></td>
            <td><input class="form-control" type="number" [(ngModel)]="newPart.PrixUnitaire" min="0" step="0.01"></td>
            <td><button class="btn btn-success btn-sm" (click)="addPart()">Ajouter</button></td>
          </tr>

          <!-- Message si aucune pi√®ce (en impression) -->
          <tr *ngIf="intervention.Pieces.length === 0 && mode === 'impression'">
            <td colspan="3" class="text-center text-muted">Aucune pi√®ce factur√©e</td>
          </tr>
        </tbody>
      </table>

      <!-- Dur√©e, Tarif, D√©placement -->
      <div class="row mt-4" *ngIf="mode === 'edition'">
        <div class="col-md-4">
          <label class="form-label"><strong>Dur√©e intervention (heures)</strong></label>
          <input class="form-control" type="number" [(ngModel)]="intervention.DureeIntervention" (input)="calculateTotals()" min="0">
        </div>
        <div class="col-md-4">
          <label class="form-label"><strong>Tarif horaire (TND)</strong></label>
          <input class="form-control" type="number" [(ngModel)]="intervention.TarifHoraire" (input)="calculateTotals()" min="0">
        </div>
        <div class="col-md-4">
          <label class="form-label"><strong>D√©placement (TND)</strong></label>
          <input class="form-control" type="number" [(ngModel)]="intervention.MontantDeplacement" (input)="calculateTotals()" min="0">
        </div>
      </div>

      <!-- Affichage en lecture seule pour impression -->
      <div class="row mt-4" *ngIf="mode === 'impression'">
        <div class="col-md-4">
          <strong>Dur√©e intervention:</strong> {{ intervention.DureeIntervention }} heures
        </div>
        <div class="col-md-4">
          <strong>Tarif horaire:</strong> {{ intervention.TarifHoraire | number:'1.2-2' }} TND
        </div>
        <div class="col-md-4">
          <strong>D√©placement:</strong> {{ intervention.MontantDeplacement | number:'1.2-2' }} TND
        </div>
      </div>

      <!-- Totaux -->
      <div class="mt-4 p-4 bg-light rounded border">
        <p><strong>Sous-total pi√®ces:</strong> {{ sousTotalPieces | number:'1.2-2' }} TND</p>
        <p><strong>Main d'≈ìuvre ({{ intervention.DureeIntervention }}h √ó {{ intervention.TarifHoraire }} TND):</strong> 
           {{ montantMainOeuvre | number:'1.2-2' }} TND</p>
        <p><strong>D√©placement:</strong> {{ intervention.MontantDeplacement | number:'1.2-2' }} TND</p>
        <p><strong>TVA ({{ (intervention.TauxTVA * 100) | number:'1.0-0' }}%):</strong> {{ tvaAmount | number:'1.2-2' }} TND</p>
        <hr>
        <p class="fs-4 fw-bold text-primary">
          Total TTC: {{ totalTTC | number:'1.2-2' }} TND
        </p>
      </div>

      <!-- Mode et statut de paiement -->
      <div class="row mt-4">
        <div class="col-md-6">
          <label class="form-label"><strong>Mode de paiement</strong></label>
          <select *ngIf="mode === 'edition'" class="form-select" [(ngModel)]="intervention.ModePaiement">
            <option>Esp√®ces</option>
            <option>Carte</option>
            <option>Ch√®que</option>
            <option>Virement</option>
          </select>
          <p *ngIf="mode === 'impression'" class="form-control-static fw-bold">{{ intervention.ModePaiement }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label"><strong>Statut du paiement</strong></label>
          <select *ngIf="mode === 'edition'" class="form-select" [(ngModel)]="intervention.StatutPaiement">
            <option>Pay√©</option>
            <option>En attente</option>
            <option>Partiellement pay√©</option>
          </select>
          <p *ngIf="mode === 'impression'" class="form-control-static fw-bold">{{ intervention.StatutPaiement }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Boutons d'action -->
  <div class="d-flex justify-content-end gap-3 mt-4">
    <!-- Mode √âdition -->
    <button *ngIf="mode === 'edition'" class="btn btn-secondary" (click)="router.navigate(['/interventions'])">
      Annuler
    </button>
    <button *ngIf="mode === 'edition'" class="btn btn-success btn-lg" (click)="submitAndGeneratePdf()">
      Cl√¥turer et G√©n√©rer la Facture
    </button>

    <!-- Mode Impression -->
  <!-- Bouton Imprimer (seulement en mode impression) -->
<div class="d-flex justify-content-end gap-3 mt-4">
<button *ngIf="mode === 'impression'" class="btn btn-primary btn-lg" (click)="genererFacturePdf()">
  üìÑ T√©l√©charger la Facture (PDF)
</button>
  <button *ngIf="mode === 'impression'" class="btn btn-outline-secondary" (click)="router.navigate(['/interventions'])">
    ‚Üê Retour √† la liste
  </button>
</div>
  </div>
</div>